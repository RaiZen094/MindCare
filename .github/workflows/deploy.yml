name: ğŸš€ Deploy MindCare Application

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.github/workflows/test-pipeline.yml'

env:
  RENDER_API_URL: https://api.render.com/v1
  
jobs:
  # Test Backend
  test-backend:
    name: ğŸ§ª Test Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: ğŸ”§ Setup Maven wrapper
      run: |
        cd backend
        chmod +x mvnw
    
    - name: ğŸ§ª Run Backend Tests
      run: |
        cd backend
        ./mvnw clean test --batch-mode --no-transfer-progress
    
    - name: ğŸ—ï¸ Build Backend
      run: |
        cd backend
        ./mvnw clean package -DskipTests --batch-mode --no-transfer-progress
    
    - name: ğŸ“¦ Upload Backend Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-jar
        path: backend/target/*.jar
        retention-days: 7

  # Test Frontend
  test-frontend:
    name: ğŸ§ª Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ğŸ“¦ Install Dependencies
      run: |
        cd frontend
        npm ci
    
    - name: ğŸ§ª Lint Code
      run: |
        cd frontend
        npm run lint || echo "Linting skipped"
    
    - name: ğŸ—ï¸ Build Frontend
      run: |
        cd frontend
        npm run build
      env:
        NEXT_PUBLIC_API_URL: https://mindcare-backend-uyos.onrender.com/api

  # Deploy Backend to Render
  deploy-backend:
    name: ğŸš€ Deploy Backend
    needs: [test-backend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸš€ Trigger Render Deployment
      run: |
        echo "ğŸš€ Triggering Render deployment..."
        response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -X POST \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Content-Type: application/json" \
          "${{ env.RENDER_API_URL }}/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
          -d '{"clearCache": false}')
        
        body=$(echo "$response" | sed -E 's/HTTP_STATUS:[0-9]+$//')
        status=$(echo "$response" | tr -d '\n' | sed -E 's/.*HTTP_STATUS:([0-9]+)$/\1/')
        
        echo "Response body: $body"
        echo "HTTP status: $status"
        
        if [ "$status" -eq 200 ] || [ "$status" -eq 201 ]; then
          echo "âœ… Deployment triggered successfully!"
        else
          echo "âŒ Failed to trigger deployment. Status: $status"
          exit 1
        fi
    
    - name: â³ Wait for Deployment
      run: |
        echo "â³ Waiting for deployment to start..."
        sleep 30
        echo "â³ Continuing to wait for deployment..."
        sleep 60
    
    - name: ğŸ¥ Health Check Backend
      run: |
        echo "ğŸ¥ Checking backend health..."
        max_attempts=15
        attempt=1
        
        while [ $attempt -le $max_attempts ]; do
          echo "ğŸ” Health check attempt $attempt/$max_attempts..."
          
          if curl -f -s --max-time 10 https://mindcare-backend-uyos.onrender.com/api/auth/health; then
            echo ""
            echo "âœ… Backend is healthy and responding!"
            exit 0
          else
            echo "â³ Backend not ready yet, waiting 20 seconds..."
            sleep 20
            attempt=$((attempt + 1))
          fi
        done
        
        echo "âŒ Backend health check failed after $max_attempts attempts"
        echo "ğŸ” Let's check what's happening..."
        curl -v https://mindcare-backend-uyos.onrender.com/api/auth/health || true
        exit 1

  # Deploy Frontend to Vercel
  deploy-frontend:
    name: ğŸš€ Deploy Frontend
    needs: [test-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸŸ¢ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ğŸ“¦ Install Vercel CLI
      run: npm i -g vercel@latest
    
    - name: ğŸ”§ Pull Vercel Environment
      run: |
        cd frontend
        vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    
    - name: ğŸ—ï¸ Build Frontend
      run: |
        cd frontend
        vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    
    - name: ğŸš€ Deploy to Vercel
      run: |
        cd frontend
        vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
      env:
        VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
        VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # Integration Tests
  integration-tests:
    name: ğŸ§ª Integration Tests
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: ğŸ§ª Test API Endpoints
      run: |
        echo "ğŸ§ª Running integration tests..."
        
        # Test health endpoint
        echo "1ï¸âƒ£ Testing health endpoint..."
        if curl -f https://mindcare-backend-uyos.onrender.com/api/auth/health; then
          echo "âœ… Health endpoint working"
        else
          echo "âŒ Health endpoint failed"
          exit 1
        fi
        
        # Test admin check endpoint
        echo "2ï¸âƒ£ Testing admin check endpoint..."
        if curl -f https://mindcare-backend-uyos.onrender.com/api/auth/admin-check; then
          echo "âœ… Admin check endpoint working"
        else
          echo "âŒ Admin check endpoint failed"
        fi
        
        # Test frontend
        echo "3ï¸âƒ£ Testing frontend..."
        if curl -f https://mind-care-zeta.vercel.app; then
          echo "âœ… Frontend is accessible"
        else
          echo "âŒ Frontend is not accessible"
        fi
        
        echo "ğŸ‰ Integration tests completed!"

  # Deployment Summary
  deployment-summary:
    name: ğŸ“¢ Deployment Summary
    needs: [deploy-backend, deploy-frontend, integration-tests]
    runs-on: ubuntu-latest
    if: always() && github.ref == 'refs/heads/master' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¢ Deployment Results
      run: |
        echo "ğŸ¯ MindCare Deployment Summary"
        echo "==============================="
        echo "Backend Deployment: ${{ needs.deploy-backend.result }}"
        echo "Frontend Deployment: ${{ needs.deploy-frontend.result }}"
        echo "Integration Tests: ${{ needs.integration-tests.result }}"
        echo ""
        
        if [ "${{ needs.deploy-backend.result }}" == "success" ] && [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
          echo "âœ… ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo ""
          echo "ğŸŒ Application URLs:"
          echo "â”œâ”€â”€ Frontend: https://mind-care-zeta.vercel.app"
          echo "â”œâ”€â”€ Backend:  https://mindcare-backend-uyos.onrender.com"
          echo "â””â”€â”€ API Docs: https://mindcare-backend-uyos.onrender.com/api/auth/health"
          echo ""
          echo "ğŸ” Admin Credentials:"
          echo "â”œâ”€â”€ Email: admin@mindcareconnect.bd"
          echo "â””â”€â”€ Password: [Check environment variables]"
        else
          echo "âŒ ğŸ’¥ DEPLOYMENT FAILED!"
          echo ""
          echo "ğŸ” Check the logs above for details."
          echo "ğŸ› ï¸ Common issues:"
          echo "â”œâ”€â”€ API keys not configured"
          echo "â”œâ”€â”€ Build failures"
          echo "â””â”€â”€ Service not responding"
        fi
